@page "/products/{Id:int}"
@using NaturalStoneImpex.Client.Models
@using NaturalStoneImpex.Client.Services
@inject IProductService ProductService
@inject CartService CartService
@inject NavigationManager Navigation

<PageTitle>@(_product?.Name ?? "Детайли за продукт") — Natural Stone Impex</PageTitle>

@if (_isLoading)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border catalog-spinner" role="status">
            <span class="visually-hidden">Зареждане...</span>
        </div>
    </div>
}
else if (_product == null)
{
    <div class="catalog-empty">
        <i class="bi bi-box-seam catalog-empty-icon"></i>
        <h3>Продуктът не е намерен.</h3>
        <a href="/catalog" class="btn btn-nsi-outline mt-3">Обратно към каталога</a>
    </div>
}
else
{
    @* Breadcrumb *@
    <nav aria-label="breadcrumb" class="pd-breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/catalog">Каталог</a></li>
            <li class="breadcrumb-item"><a href="/catalog?categoryId=@_product.CategoryId">@_product.CategoryName</a></li>
            <li class="breadcrumb-item active" aria-current="page">@_product.Name</li>
        </ol>
    </nav>

    <div class="row g-4 g-md-5">
        @* Left column — Image *@
        <div class="col-12 col-md-6">
            @if (!string.IsNullOrEmpty(_product.ImagePath))
            {
                <div class="img-zoom-wrapper pd-image-wrapper">
                    <img src="@_product.ImagePath" alt="@_product.Name" class="pd-image" />
                </div>
            }
            else
            {
                <div class="pd-image-placeholder">
                    <i class="bi bi-image pd-placeholder-icon"></i>
                    <span>Няма снимка</span>
                </div>
            }
        </div>

        @* Right column — Product info *@
        <div class="col-12 col-md-6">
            <h2 class="pd-name">@_product.Name</h2>
            <span class="badge badge-nsi-accent pd-category-badge">@_product.CategoryName</span>

            @if (!string.IsNullOrEmpty(_product.Description))
            {
                <p class="pd-description">@_product.Description</p>
            }

            @* Price section *@
            <div class="pd-price-block">
                <div class="pd-price-main">@_product.PriceWithVat.ToString("F2") €</div>
                <div class="pd-price-label">Цена с ДДС</div>
                <div class="pd-price-details">
                    <span>Цена без ДДС: @_product.PriceWithoutVat.ToString("F2") € без ДДС</span>
                    <span>ДДС: @_product.VatAmount.ToString("F2") € ДДС</span>
                </div>
            </div>

            @* Stock & unit *@
            <div class="pd-meta">
                <div class="pd-meta-item">
                    @if (_product.StockQuantity > 0)
                    {
                        <span class="badge badge-nsi-success pd-stock-badge">В наличност</span>
                    }
                    else
                    {
                        <span class="badge badge-nsi-danger pd-stock-badge">Изчерпан</span>
                    }
                </div>
                <div class="pd-meta-item pd-unit">
                    Мерна единица: @_product.UnitDisplay
                </div>
            </div>

            @* Order section — hidden on mobile (sticky bar handles it) *@
            <div class="pd-order-section d-none d-md-block">
                <label class="form-label fw-semibold">Количество (@_product.UnitDisplay)</label>
                <input type="number" class="form-control pd-qty-input mb-3"
                       min="0.01" step="0.01"
                       @bind="_quantity"
                       disabled="@(_product.StockQuantity <= 0)" />

                <button class="btn btn-nsi-accent btn-lg pd-add-btn"
                        disabled="@(_product.StockQuantity <= 0)"
                        @onclick="AddToCart">
                    <i class="bi bi-cart-plus me-2"></i>Добави в количката
                </button>
            </div>

            @* Quantity input visible on mobile (above sticky bar) *@
            <div class="pd-order-section d-md-none">
                <label class="form-label fw-semibold">Количество (@_product.UnitDisplay)</label>
                <input type="number" class="form-control pd-qty-input"
                       min="0.01" step="0.01"
                       @bind="_quantity"
                       disabled="@(_product.StockQuantity <= 0)" />
            </div>

            <a href="/catalog" class="pd-back-link d-none d-md-inline-flex">
                <i class="bi bi-arrow-left me-1"></i> Обратно към каталога
            </a>
        </div>
    </div>

    @* Mobile sticky CTA bar *@
    <div class="pd-sticky-bar d-md-none">
        <div class="pd-sticky-price">@_product.PriceWithVat.ToString("F2") €</div>
        <button class="btn btn-nsi-accent pd-sticky-btn"
                disabled="@(_product.StockQuantity <= 0)"
                @onclick="AddToCart">
            <i class="bi bi-cart-plus me-2"></i>Добави в количката
        </button>
    </div>
}

<ToastNotification @ref="_toast" />

@code {
    [Parameter]
    public int Id { get; set; }

    private ProductDto? _product;
    private bool _isLoading = true;
    private decimal _quantity = 1;
    private ToastNotification _toast = default!;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        _product = await ProductService.GetByIdAsync(Id);
        _isLoading = false;
    }

    private void AddToCart()
    {
        if (_product == null || _quantity <= 0) return;

        CartService.AddItem(new CartItem
        {
            ProductId = _product.Id,
            ProductName = _product.Name,
            UnitPriceWithVat = _product.PriceWithVat,
            VatAmount = _product.VatAmount,
            UnitPriceWithoutVat = _product.PriceWithoutVat,
            Unit = _product.Unit,
            UnitDisplay = _product.UnitDisplay,
            Quantity = _quantity,
            ImagePath = _product.ImagePath
        });
        _toast.Show("Продуктът е добавен в количката.");
    }
}
