@page "/admin/orders/{Id:int}"
@layout AdminLayout
@attribute [Authorize]
@inject IOrderService OrderService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>@(_order is not null ? $"Поръчка {_order.OrderNumber}" : "Поръчка") — Natural Stone Impex</PageTitle>

<!-- Back link -->
<a href="/admin/orders" class="od-back-link mb-3">
    <i class="bi bi-arrow-left"></i> Обратно към поръчките
</a>

@if (_isLoading)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border" style="color: var(--nsi-accent);" role="status">
            <span class="visually-hidden">Зареждане...</span>
        </div>
    </div>
}
else if (_order is null)
{
    <div class="admin-empty-state">
        <i class="bi bi-question-circle admin-empty-icon"></i>
        <p class="admin-empty-text">Поръчката не е намерена.</p>
        <a href="/admin/orders" class="btn btn-nsi-outline mt-2">Обратно към поръчките</a>
    </div>
}
else
{
    @* Alert messages *@
    @if (_successMessage is not null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@_successMessage
            <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
        </div>
    }
    @if (_warningMessage is not null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>@_warningMessage
            <button type="button" class="btn-close" @onclick="() => _warningMessage = null"></button>
        </div>
    }
    @if (_errorMessage is not null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
            @if (_stockDetails is not null)
            {
                <div class="table-container mt-2" style="background: var(--nsi-white);">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Продукт</th>
                                <th>Поръчано</th>
                                <th>Налично</th>
                                <th>Мерна ед.</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var d in _stockDetails)
                            {
                                <tr>
                                    <td>@d.ProductName</td>
                                    <td>@d.Ordered.ToString("F2")</td>
                                    <td>@d.Available.ToString("F2")</td>
                                    <td>@d.Unit</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            <button type="button" class="btn-close" @onclick="DismissError"></button>
        </div>
    }

    @* Cancelled banner *@
    @if (_order.IsCancelled)
    {
        <div class="od-cancelled-banner mb-3">
            <i class="bi bi-x-octagon me-2"></i>ОТКАЗАНА
        </div>
    }

    @* Order Header *@
    <div class="od-header">
        <h2 class="od-order-number">@_order.OrderNumber</h2>
        @if (_order.IsCancelled)
        {
            <span class="badge badge-status-cancelled fs-6">Отказана</span>
        }
        else
        {
            <span class="badge @GetStatusBadgeClass(_order.Status) fs-6">@_order.StatusDisplay</span>
        }
        <span class="od-order-date">
            <i class="bi bi-calendar3 me-1"></i>@_order.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
        </span>
    </div>

    @* Two-column layout: Order Info + Customer Info side by side on desktop *@
    <div class="row g-4 mb-4">
        @* Card 1 — Order Info *@
        <div class="col-12 col-lg-6">
            <div class="od-card h-100">
                <div class="od-card-header">
                    <i class="bi bi-receipt"></i> Данни за поръчката
                </div>
                <div class="od-card-body">
                    <div class="od-info-row">
                        <span class="od-info-label">Номер</span>
                        <span class="od-info-value order-number-mono">@_order.OrderNumber</span>
                    </div>
                    <div class="od-info-row">
                        <span class="od-info-label">Дата</span>
                        <span class="od-info-value">@_order.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                    <div class="od-info-row">
                        <span class="od-info-label">Статус</span>
                        <span class="od-info-value">
                            @if (_order.IsCancelled)
                            {
                                <span class="badge badge-status-cancelled">Отказана</span>
                            }
                            else
                            {
                                <span class="badge @GetStatusBadgeClass(_order.Status)">@_order.StatusDisplay</span>
                            }
                        </span>
                    </div>
                    <div class="od-info-row">
                        <span class="od-info-label">Метод на доставка</span>
                        <span class="od-info-value">@(_order.DeliveryMethod == 0 ? "Вземане от обекта" : "Доставка")</span>
                    </div>
                </div>
            </div>
        </div>

        @* Card 2 — Customer Info *@
        <div class="col-12 col-lg-6">
            <div class="od-card h-100">
                <div class="od-card-header">
                    <i class="bi bi-person"></i> Данни за клиента
                </div>
                <div class="od-card-body">
                    <div class="mb-2">
                        <span class="badge" style="background: var(--nsi-light); color: var(--nsi-gray-dark); font-weight: 500;">@_order.CustomerTypeDisplay</span>
                    </div>

                    @if (_order.CustomerType == 0)
                    {
                        @* Individual *@
                        <div class="od-info-row">
                            <span class="od-info-label">Име</span>
                            <span class="od-info-value">@_order.CustomerInfo.FullName</span>
                        </div>
                        <div class="od-info-row">
                            <span class="od-info-label">Телефон</span>
                            <span class="od-info-value">@_order.CustomerInfo.Phone</span>
                        </div>
                        @if (_order.DeliveryMethod == 1 && !string.IsNullOrWhiteSpace(_order.CustomerInfo.Address))
                        {
                            <div class="od-info-row">
                                <span class="od-info-label">Адрес</span>
                                <span class="od-info-value">@_order.CustomerInfo.Address</span>
                            </div>
                        }
                    }
                    else
                    {
                        @* Company *@
                        <div class="od-info-row">
                            <span class="od-info-label">Фирма</span>
                            <span class="od-info-value">@_order.CustomerInfo.CompanyName</span>
                        </div>
                        <div class="od-info-row">
                            <span class="od-info-label">ЕИК</span>
                            <span class="od-info-value">@_order.CustomerInfo.Eik</span>
                        </div>
                        <div class="od-info-row">
                            <span class="od-info-label">МОЛ</span>
                            <span class="od-info-value">@_order.CustomerInfo.Mol</span>
                        </div>
                        <div class="od-info-row">
                            <span class="od-info-label">Лице за контакт</span>
                            <span class="od-info-value">@_order.CustomerInfo.ContactPerson</span>
                        </div>
                        <div class="od-info-row">
                            <span class="od-info-label">Телефон</span>
                            <span class="od-info-value">@_order.CustomerInfo.ContactPhone</span>
                        </div>
                        @if (_order.DeliveryMethod == 1 && !string.IsNullOrWhiteSpace(_order.CustomerInfo.Address))
                        {
                            <div class="od-info-row">
                                <span class="od-info-label">Адрес</span>
                                <span class="od-info-value">@_order.CustomerInfo.Address</span>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    @* Card 3 — Order Items (full-width) *@
    <div class="od-card mb-4">
        <div class="od-card-header">
            <i class="bi bi-box-seam"></i> Артикули
        </div>
        <div class="table-container" style="border-radius: 0; box-shadow: none;">
            <div style="overflow-x: auto;">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="width: 50px;">№</th>
                            <th>Продукт</th>
                            <th>Мерна ед.</th>
                            <th class="text-end">Количество</th>
                            <th class="text-end">Ед. цена без ДДС</th>
                            <th class="text-end">ДДС</th>
                            <th class="text-end">Ед. цена с ДДС</th>
                            <th class="text-end">Общо с ДДС</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (var i = 0; i < _order.Items.Count; i++)
                        {
                            var item = _order.Items[i];
                            <tr>
                                <td style="color: var(--nsi-gray);">@(i + 1)</td>
                                <td>
                                    <span class="fw-semibold" style="color: var(--nsi-dark);">@item.ProductName</span>
                                </td>
                                <td style="color: var(--nsi-gray-dark);">@item.UnitDisplay</td>
                                <td class="text-end">@item.Quantity.ToString("F2")</td>
                                <td class="text-end" style="color: var(--nsi-gray-dark);">@item.UnitPriceWithoutVat.ToString("F2") &euro;</td>
                                <td class="text-end" style="color: var(--nsi-gray-dark);">@item.VatAmount.ToString("F2") &euro;</td>
                                <td class="text-end" style="color: var(--nsi-gray-dark);">@item.UnitPriceWithVat.ToString("F2") &euro;</td>
                                <td class="text-end">
                                    <span class="fw-semibold" style="color: var(--nsi-accent-dark);">@item.RowTotalWithVat.ToString("F2") &euro;</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @* Card 4 — Totals *@
    <div class="d-flex justify-content-end mb-4">
        <div class="od-card od-totals-card" style="min-width: 320px; max-width: 420px; width: 100%;">
            <div class="od-card-header">
                <i class="bi bi-calculator"></i> Обобщение
            </div>
            <div class="od-card-body">
                <div class="od-info-row">
                    <span class="od-info-label">Сума без ДДС</span>
                    <span class="od-info-value">@_order.SubtotalWithoutVat.ToString("F2") &euro;</span>
                </div>
                <div class="od-info-row">
                    <span class="od-info-label">Общо ДДС</span>
                    <span class="od-info-value">@_order.TotalVat.ToString("F2") &euro;</span>
                </div>
                <div class="od-info-row">
                    <span class="od-info-label">Сума с ДДС</span>
                    <span class="od-info-value">@_order.SubtotalWithVat.ToString("F2") &euro;</span>
                </div>
                <div class="od-info-row">
                    <span class="od-info-label">Цена за доставка</span>
                    <span class="od-info-value">
                        @if (_order.DeliveryMethod == 0)
                        {
                            @:Не се прилага
                        }
                        else if (_order.DeliveryFee.HasValue)
                        {
                            @:@_order.DeliveryFee.Value.ToString("F2") €
                        }
                        else
                        {
                            <span style="color: var(--nsi-warning);">Не е определена</span>
                        }
                    </span>
                </div>
                <hr style="border-color: var(--nsi-gray-light); margin: 0.75rem 0;" />
                <div class="d-flex justify-content-between align-items-center">
                    <span class="od-grand-total">Обща сума:</span>
                    <span class="od-grand-total">@_order.GrandTotal.ToString("F2") &euro;</span>
                </div>
            </div>
        </div>
    </div>

    @* Completed/Confirmed dates *@
    @if (_order.Status == 2 && !_order.IsCancelled)
    {
        <div class="od-timestamps mb-4">
            @if (_order.ConfirmedAt.HasValue)
            {
                <span><i class="bi bi-check-circle me-1"></i> Потвърдена на: @_order.ConfirmedAt.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
            }
            @if (_order.CompletedAt.HasValue)
            {
                <span><i class="bi bi-check-all me-1"></i> Завършена на: @_order.CompletedAt.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
            }
        </div>
    }

    @* Section 5 — Actions *@
    <div class="od-card mb-4">
        <div class="od-card-header">
            <i class="bi bi-gear"></i> Действия
        </div>
        <div class="od-card-body">
            @if (_order.IsCancelled)
            {
                <div class="od-cancelled-banner" style="margin: 0;">
                    <i class="bi bi-x-octagon me-2"></i>Тази поръчка е отказана.
                </div>
            }
            else if (_order.Status == 0)
            {
                @* Pending *@
                @if (_order.DeliveryMethod == 1)
                {
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Цена за доставка (&euro;)</label>
                        <div class="input-group od-delivery-input">
                            <input type="number" class="form-control" min="0" step="0.01"
                                   @bind="_deliveryFeeInput" @bind:event="oninput" />
                            <button class="btn btn-nsi-primary btn-sm" disabled="@_isActionLoading"
                                    @onclick="SetDeliveryFee">
                                @if (_isActionLoading && _activeAction == "deliveryFee")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                Задай
                            </button>
                        </div>
                    </div>
                }

                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-nsi-success" disabled="@_isActionLoading"
                            @onclick="() => ShowConfirmModal(ConfirmAction.Confirm)">
                        @if (_isActionLoading && _activeAction == "confirm")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check-lg me-1"></i>Потвърди поръчката
                    </button>
                    <button class="btn btn-nsi-danger-outline" disabled="@_isActionLoading"
                            @onclick="() => ShowConfirmModal(ConfirmAction.Cancel)">
                        @if (_isActionLoading && _activeAction == "cancel")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-x-lg me-1"></i>Откажи поръчката
                    </button>
                </div>
            }
            else if (_order.Status == 1)
            {
                @* Confirmed *@
                @if (_order.DeliveryMethod == 1 && !_order.DeliveryFee.HasValue)
                {
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Цена за доставка (&euro;)</label>
                        <div class="input-group od-delivery-input">
                            <input type="number" class="form-control" min="0" step="0.01"
                                   @bind="_deliveryFeeInput" @bind:event="oninput" />
                            <button class="btn btn-nsi-primary btn-sm" disabled="@_isActionLoading"
                                    @onclick="SetDeliveryFee">
                                @if (_isActionLoading && _activeAction == "deliveryFee")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                Задай
                            </button>
                        </div>
                    </div>
                }

                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-nsi-success" disabled="@_isActionLoading"
                            @onclick="() => ShowConfirmModal(ConfirmAction.Complete)">
                        @if (_isActionLoading && _activeAction == "complete")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check-all me-1"></i>Маркирай като завършена
                    </button>
                    <a href="/admin/orders/@_order.Id/receipt" target="_blank" class="btn btn-nsi-outline">
                        <i class="bi bi-printer me-1"></i> Принтирай разписка
                    </a>
                </div>
            }
            else if (_order.Status == 2)
            {
                @* Completed *@
                <a href="/admin/orders/@_order.Id/receipt" target="_blank" class="btn btn-nsi-outline">
                    <i class="bi bi-printer me-1"></i> Принтирай разписка
                </a>
            }
        </div>
    </div>
}

@* Confirmation Modal *@
@if (_showModal)
{
    <div class="od-modal-overlay" tabindex="-1">
        <div class="od-modal-card">
            <div class="od-modal-header">
                <h5 class="mb-0" style="font-family: var(--nsi-font-display); font-weight: 700;">
                    <i class="bi bi-question-circle me-2" style="color: var(--nsi-accent-dark);"></i>Потвърждение
                </h5>
                <button type="button" class="btn-close" @onclick="CloseModal"></button>
            </div>
            <div class="od-modal-body">
                <p class="mb-0">@_modalMessage</p>
            </div>
            <div class="od-modal-footer">
                <button type="button" class="btn btn-nsi-outline" @onclick="CloseModal">Отказ</button>
                <button type="button" class="btn @_modalButtonClass" @onclick="ExecuteModalAction" disabled="@_isActionLoading">
                    @if (_isActionLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Да
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private OrderDetailDto? _order;
    private bool _isLoading = true;
    private bool _isActionLoading;
    private string? _activeAction;
    private string? _successMessage;
    private string? _warningMessage;
    private string? _errorMessage;
    private List<StockShortageDetail>? _stockDetails;
    private decimal _deliveryFeeInput;

    // Modal
    private bool _showModal;
    private string _modalMessage = string.Empty;
    private string _modalButtonClass = "btn-primary";
    private ConfirmAction _pendingAction;

    private System.Threading.Timer? _autoDismissTimer;

    private enum ConfirmAction { Confirm, Cancel, Complete }

    protected override async Task OnInitializedAsync()
    {
        await LoadOrderAsync();
    }

    private async Task LoadOrderAsync()
    {
        _isLoading = true;
        try
        {
            _order = await OrderService.GetByIdAsync(Id);
            if (_order?.DeliveryFee.HasValue == true)
                _deliveryFeeInput = _order.DeliveryFee.Value;
        }
        catch
        {
            _order = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowConfirmModal(ConfirmAction action)
    {
        _pendingAction = action;
        (_modalMessage, _modalButtonClass) = action switch
        {
            ConfirmAction.Confirm => ("Сигурни ли сте, че искате да потвърдите тази поръчка?\nНаличностите ще бъдат намалени.", "btn-success"),
            ConfirmAction.Cancel => ("Сигурни ли сте, че искате да откажете тази поръчка?", "btn-danger"),
            ConfirmAction.Complete => ("Маркирай поръчката като завършена?", "btn-success"),
            _ => ("", "btn-primary")
        };
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
    }

    private async Task ExecuteModalAction()
    {
        _showModal = false;
        _isActionLoading = true;
        ClearMessages();

        switch (_pendingAction)
        {
            case ConfirmAction.Confirm:
                await ConfirmOrder();
                break;
            case ConfirmAction.Cancel:
                await CancelOrder();
                break;
            case ConfirmAction.Complete:
                await CompleteOrder();
                break;
        }

        _isActionLoading = false;
    }

    private async Task ConfirmOrder()
    {
        _activeAction = "confirm";
        var (error, details) = await OrderService.ConfirmAsync(Id);

        if (error is not null)
        {
            _errorMessage = error;
            _stockDetails = details;
        }
        else
        {
            await LoadOrderAsync();
            ShowSuccess("Поръчката е потвърдена.");
        }
        _activeAction = null;
    }

    private async Task CancelOrder()
    {
        _activeAction = "cancel";
        var error = await OrderService.CancelAsync(Id);

        if (error is not null)
        {
            _errorMessage = error;
        }
        else
        {
            await LoadOrderAsync();
            ShowWarning("Поръчката е отказана.");
        }
        _activeAction = null;
    }

    private async Task CompleteOrder()
    {
        _activeAction = "complete";
        var error = await OrderService.CompleteAsync(Id);

        if (error is not null)
        {
            _errorMessage = error;
        }
        else
        {
            await LoadOrderAsync();
            ShowSuccess("Поръчката е завършена.");
        }
        _activeAction = null;
    }

    private async Task SetDeliveryFee()
    {
        _isActionLoading = true;
        _activeAction = "deliveryFee";
        ClearMessages();

        var error = await OrderService.SetDeliveryFeeAsync(Id, _deliveryFeeInput);
        if (error is not null)
        {
            _errorMessage = error;
        }
        else
        {
            await LoadOrderAsync();
            ShowSuccess("Цената за доставка е зададена.");
        }

        _activeAction = null;
        _isActionLoading = false;
    }

    private void ClearMessages()
    {
        _successMessage = null;
        _warningMessage = null;
        _errorMessage = null;
        _stockDetails = null;
        _autoDismissTimer?.Dispose();
        _autoDismissTimer = null;
    }

    private void ShowSuccess(string message)
    {
        _successMessage = message;
        StartAutoDismiss(() => { _successMessage = null; InvokeAsync(StateHasChanged); });
    }

    private void ShowWarning(string message)
    {
        _warningMessage = message;
        StartAutoDismiss(() => { _warningMessage = null; InvokeAsync(StateHasChanged); });
    }

    private void StartAutoDismiss(Action callback)
    {
        _autoDismissTimer?.Dispose();
        _autoDismissTimer = new System.Threading.Timer(_ => callback(), null, 5000, Timeout.Infinite);
    }

    private void DismissError()
    {
        _errorMessage = null;
        _stockDetails = null;
    }

    private static string GetStatusBadgeClass(int status) => status switch
    {
        0 => "bg-warning text-dark",
        1 => "bg-info text-white",
        2 => "bg-success text-white",
        _ => "bg-secondary"
    };

    public void Dispose()
    {
        _autoDismissTimer?.Dispose();
    }
}
